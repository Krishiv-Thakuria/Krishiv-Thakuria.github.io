<!DOCTYPE html>
<html>
<head>
    <title>CodeCell Car Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        
        #connectButton {
            padding: 20px 40px;
            font-size: 20px;
            border: none;
            border-radius: 10px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        
        #joystickZone {
            width: 200px;
            height: 200px;
            background-color: #ddd;
            border-radius: 50%;
            position: relative;
            display: none;
            margin-top: 20px;
            touch-action: none;
        }
        
        #stick {
            width: 60px;
            height: 60px;
            background-color: #2196F3;
            border-radius: 50%;
            position: absolute;
            top: 70px;
            left: 70px;
            cursor: pointer;
            touch-action: none;
        }
    </style>
</head>
<body>
    <button id="connectButton">Connect to Car</button>
    <div id="joystickZone">
        <div id="stick"></div>
    </div>

    <script>
        let characteristic;
        let isDragging = false;
        let lastCommand = '';
        const stick = document.getElementById('stick');
        const zone = document.getElementById('joystickZone');
        
        async function connectToCar() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'CodeCell-Car' }],
                    optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
                });
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
                characteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
                
                document.getElementById('connectButton').style.display = 'none';
                document.getElementById('joystickZone').style.display = 'block';
            } catch (error) {
                console.error(error);
            }
        }
        
        async function sendCommand(command) {
            if (characteristic && command !== lastCommand) {
                try {
                    const encoder = new TextEncoder();
                    await characteristic.writeValue(encoder.encode(command));
                    lastCommand = command;
                } catch (error) {
                    console.error(error);
                }
            }
        }

        function handleJoystick(e) {
            if (!isDragging) return;
            
            const rect = zone.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            let x = e.type.includes('touch') ? 
                e.touches[0].clientX - rect.left : 
                e.clientX - rect.left;
            let y = e.type.includes('touch') ? 
                e.touches[0].clientY - rect.top : 
                e.clientY - rect.top;

            // Calculate distance from center
            const deltaX = x - centerX;
            const deltaY = y - centerY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            
            // Limit stick to circle boundary
            if (distance > centerX) {
                x = centerX + (deltaX / distance) * centerX;
                y = centerY + (deltaY / distance) * centerX;
            }
            
            // Update stick position
            stick.style.left = (x - 30) + 'px';
            stick.style.top = (y - 30) + 'px';
            
            // Determine command based on position
            const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
            const deadzone = 30; // pixels from center

            if (distance < deadzone) {
                sendCommand('S');
            } else {
                // Divide circle into 4 quadrants
                if (angle > -45 && angle <= 45) sendCommand('R');
                else if (angle > 45 && angle <= 135) sendCommand('B');
                else if (angle > 135 || angle <= -135) sendCommand('L');
                else if (angle > -135 && angle <= -45) sendCommand('F');
            }
        }
        
        document.getElementById('connectButton').addEventListener('click', connectToCar);
        
        // Touch Events
        stick.addEventListener('touchstart', (e) => {
            isDragging = true;
            e.preventDefault();
        });
        
        document.addEventListener('touchend', () => {
            isDragging = false;
            stick.style.left = '70px';
            stick.style.top = '70px';
            sendCommand('S');
        });
        
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
            handleJoystick(e);
        });
        
        // Mouse Events (for testing)
        stick.addEventListener('mousedown', () => isDragging = true);
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
            stick.style.left = '70px';
            stick.style.top = '70px';
            sendCommand('S');
        });
        
        document.addEventListener('mousemove', handleJoystick);
    </script>
</body>
</html>
